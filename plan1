<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آلية التسعير المزدوج الجديدة | تحليل النظام</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Cairo for Arabic Modern Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Project Palette -->
    <!-- 
        Palette Name: Corporate Dynamic
        Primary Blue (Stability/Driver): #1E40AF (blue-800)
        Accent Orange (Variable/Merchant): #F97316 (orange-500)
        Background: #F3F4F6 (gray-100)
        Card Bg: #FFFFFF (white)
        Text Main: #111827 (gray-900)
    -->

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #F3F4F6;
            color: #1F2937;
        }

        /* Chart Container Styling Rules */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Constraint width for readability */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Base height */
            max-height: 400px;
        }
        
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Flowchart Connector Lines via CSS */
        .flow-line {
            width: 2px;
            background-color: #9CA3AF;
            height: 20px;
            margin: 0 auto;
        }
        
        .flow-arrow-down::after {
            content: '▼';
            display: block;
            text-align: center;
            color: #9CA3AF;
            font-size: 12px;
            line-height: 10px;
        }

        .flow-branch {
            display: flex;
            justify-content: center;
            position: relative;
            padding-top: 20px;
        }

        .flow-branch::before {
            content: '';
            position: absolute;
            top: 0;
            left: 25%;
            right: 25%;
            height: 20px;
            border-top: 2px solid #9CA3AF;
            border-left: 2px solid #9CA3AF;
            border-right: 2px solid #9CA3AF;
        }
    </style>
    <!-- 
        HTML Comment: 
        Source Material Analysis:
        - Core Concept: Separation of Revenue (Merchant) and Expense (Driver).
        - Revenue: Variable based on Restaurant ID + Distance.
        - Expense: Fixed based on Distance only.
        - Structure: Intro -> Merchant Mechanism -> Driver Mechanism -> Logic Flowchart -> Implementation Plan.
        
        Visual Choices (NO SVG/Mermaid):
        1. Merchant Fees: Bar Chart (Compare) -> Shows different fees for same distance.
        2. Driver Pay: Line Chart (Change/Trend) -> Shows stability across distance.
        3. Logic Flow: CSS/HTML Grid -> Shows parallel processing.
        4. Formula: Styled HTML Box -> Shows hourly calculation.
        
        Palette: Vibrant Blue (Drivers/Stability) & Orange (Merchants/Revenue).
    -->
</head>
<body class="antialiased">

    <!-- Header Section -->
    <header class="bg-blue-900 text-white py-12 shadow-lg">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">آلية التسعير المزدوج (Dual Pricing)</h1>
            <p class="text-xl md:text-2xl font-light text-blue-100 max-w-3xl mx-auto">
                تحليل النظام المقترح لفصل مسار الإيرادات (المطاعم) عن مسار المصروفات (السائقين) لضمان الربحية واستقرار الأجور.
            </p>
        </div>
    </header>

    <!-- Main Content Container -->
    <main class="container mx-auto px-4 py-8 space-y-12">

        <!-- Executive Summary Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
            <div class="bg-white p-8 rounded-xl shadow-md border-r-4 border-orange-500">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">الهدف الاستراتيجي</h2>
                <p class="text-gray-600 leading-relaxed mb-4">
                    يهدف النظام الجديد إلى إلغاء الارتباط المباشر بين ما يدفعه المطعم وما يحصل عليه السائق. بدلاً من الاعتماد على "سعر عام"، نقوم بإنشاء مسارين منفصلين:
                </p>
                <ul class="space-y-3">
                    <li class="flex items-center text-gray-700">
                        <span class="w-3 h-3 bg-orange-500 rounded-full ml-3"></span>
                        <strong>مسار الإيراد (مرن):</strong> تفاوض تجاري خاص مع كل مطعم.
                    </li>
                    <li class="flex items-center text-gray-700">
                        <span class="w-3 h-3 bg-blue-600 rounded-full ml-3"></span>
                        <strong>مسار المصروف (ثابت):</strong> أجر عادل وموحد للسائقين حسب المسافة.
                    </li>
                </ul>
            </div>
            
            <!-- Summary Statistic (Donut Chart Concept using Chart.js) -->
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-bold text-center mb-2">مثال: هيكلة الطلب الواحد</h3>
                <p class="text-sm text-gray-500 text-center mb-4">كيف يتم توزيع قيمة التوصيل المحصلة</p>
                <div class="chart-container">
                    <canvas id="marginChart"></canvas>
                </div>
                <p class="text-center text-xs text-gray-400 mt-2">هامش الربح يصبح متغيراً بتغير اتفاقية المطعم</p>
            </div>
        </section>

        <!-- Section 1: Merchant Mechanism (Revenue) -->
        <section>
            <div class="border-b-2 border-gray-200 mb-6 pb-2">
                <h2 class="text-3xl font-bold text-gray-800">1. آلية المطاعم: الإيراد المتغير</h2>
            </div>
            <p class="text-gray-600 mb-8 max-w-4xl">
                في هذا النموذج، لا يدفع كل التجار نفس السعر لنفس المسافة. يتم تحديد "جدول رسوم خاصة" لكل مطعم بناءً على قوته التجارية وتفاوضه مع المنصة. هذا يسمح بزيادة الإيرادات من المطاعم الكبرى أو تقديم خصومات للمطاعم الناشئة دون التأثير على أجر السائق.
            </p>

            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 flex flex-col justify-center space-y-4">
                        <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                            <h4 class="font-bold text-orange-800 text-lg mb-2">المتغيرات الرئيسية</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
                                <li>المسافة (كم)</li>
                                <li>هوية المطعم (Restaurant ID)</li>
                                <li>قوة التفاوض التجارية</li>
                            </ul>
                        </div>
                        <div class="text-sm text-gray-500">
                            <strong class="block mb-1">النتيجة:</strong>
                            لنفس مشوار الـ 5 كم، قد نحصل على إيرادات متفاوتة (100، 110، 120) مما يعظم الربحية الإجمالية.
                        </div>
                    </div>
                    
                    <div class="lg:col-span-2">
                        <h3 class="text-center font-semibold mb-4 text-gray-700">مقارنة رسوم التوصيل لثلاث مطاعم (لنفس المسافة: 5 كم)</h3>
                        <div class="chart-container">
                            <canvas id="merchantChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Driver Mechanism (Expense) -->
        <section>
            <div class="border-b-2 border-gray-200 mb-6 pb-2">
                <h2 class="text-3xl font-bold text-gray-800">2. آلية السائقين: المصروف الثابت والهجين</h2>
            </div>
            <p class="text-gray-600 mb-8 max-w-4xl">
                لضمان رضا السائقين واستقرار العمليات، يتم فصل أجر السائق عن اتفاقيات المطاعم. السائق يحصل على حقه بناءً على الجهد (المسافة) فقط، بغض النظر عما إذا كان المطعم يدفع رسوماً عالية أو منخفضة للمنصة.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Driver Types Cards -->
                <div class="space-y-6">
                    <!-- On-Demand Driver -->
                    <div class="bg-blue-50 border-r-4 border-blue-600 p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-blue-900 mb-2">أ. السائق الحر (بالطلب)</h3>
                        <p class="text-gray-700 text-sm mb-3">يحصل على أجر ثابت لكل شريحة مسافة.</p>
                        <div class="bg-white p-3 rounded border border-blue-100 text-center font-mono text-blue-800">
                            أجر السائق = دالة(المسافة فقط)
                        </div>
                    </div>

                    <!-- Hourly Driver -->
                    <div class="bg-indigo-50 border-r-4 border-indigo-600 p-6 rounded-lg shadow-sm">
                        <h3 class="text-xl font-bold text-indigo-900 mb-2">ب. السائق بالساعة (الهجين)</h3>
                        <p class="text-gray-700 text-sm mb-3">نظام يجمع بين الأمان الوظيفي والحافز.</p>
                        <div class="bg-white p-4 rounded border border-indigo-100 text-center">
                            <p class="font-mono text-indigo-800 text-sm md:text-base dir-ltr">
                                Total Pay = (Hourly Rate × Hours) + (Bonus × Orders)
                            </p>
                            <p class="text-xs text-gray-500 mt-2">يتطلب نظام تسجيل دخول/خروج (Clock-in/out)</p>
                        </div>
                    </div>
                </div>

                <!-- Driver Chart -->
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-center font-semibold mb-4 text-gray-700">استقرار أجور السائقين عبر المسافات</h3>
                    <div class="chart-container">
                        <canvas id="driverChart"></canvas>
                    </div>
                    <p class="text-center text-xs text-gray-400 mt-2">لاحظ أن الأجر يزداد بانتظام مع المسافة، غير متأثر بنوع المطعم</p>
                </div>
            </div>
        </section>

        <!-- Section 3: Process Flow Diagram (CSS Implementation) -->
        <section class="bg-gray-50 p-8 rounded-2xl border border-gray-200">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-gray-800 mb-2">مخطط تدفق العمليات (Workflow)</h2>
                <p class="text-gray-500">كيف يقوم النظام بمعالجة الطلب وفصل المسارات لحظياً</p>
            </div>

            <!-- Flowchart Container -->
            <div class="max-w-3xl mx-auto font-bold text-sm md:text-base">
                
                <!-- Start -->
                <div class="flex justify-center">
                    <div class="bg-gray-800 text-white px-8 py-3 rounded-full shadow-lg">
                        بدء طلب جديد (New Order)
                    </div>
                </div>

                <!-- Arrow -->
                <div class="flow-line flow-arrow-down"></div>

                <!-- Distance Calc -->
                <div class="flex justify-center">
                    <div class="bg-white border-2 border-gray-400 text-gray-700 px-6 py-3 rounded shadow-sm">
                        حساب المسافة (Distance Calculation)
                    </div>
                </div>

                <!-- Branching Lines -->
                <div class="flow-branch"></div>

                <!-- Parallel Processing Grid -->
                <div class="grid grid-cols-2 gap-4 md:gap-12 relative">
                    
                    <!-- Left Branch: Revenue -->
                    <div class="flex flex-col items-center">
                        <div class="flow-line flow-arrow-down"></div>
                        <div class="bg-orange-100 border-2 border-orange-500 text-orange-900 px-4 py-4 rounded-lg text-center w-full shadow-md">
                            <div class="uppercase tracking-wider text-xs text-orange-600 mb-1">مسار الإيراد</div>
                            بحث: هوية المطعم + المسافة
                        </div>
                        <div class="flow-line flow-arrow-down"></div>
                        <div class="bg-orange-500 text-white px-4 py-4 rounded-lg text-center w-full shadow-lg">
                            استرجاع: رسوم التوصيل المتغيرة
                            <br><span class="text-xs opacity-75">(Delivery Fee)</span>
                        </div>
                    </div>

                    <!-- Right Branch: Expense -->
                    <div class="flex flex-col items-center">
                        <div class="flow-line flow-arrow-down"></div>
                        <div class="bg-blue-100 border-2 border-blue-600 text-blue-900 px-4 py-4 rounded-lg text-center w-full shadow-md">
                            <div class="uppercase tracking-wider text-xs text-blue-600 mb-1">مسار المصروف</div>
                            بحث: المسافة فقط
                        </div>
                        <div class="flow-line flow-arrow-down"></div>
                        <div class="bg-blue-600 text-white px-4 py-4 rounded-lg text-center w-full shadow-lg">
                            استرجاع: أجر السائق الثابت
                            <br><span class="text-xs opacity-75">(Driver Payout)</span>
                        </div>
                    </div>

                </div>

                <!-- Joining Lines (Visual trickery with spacing) -->
                <div class="mt-4 flex justify-center text-gray-400 text-2xl">
                    ▼ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ▼
                </div>

                <!-- End Process -->
                <div class="flex justify-center mt-2">
                    <div class="bg-green-600 text-white px-12 py-4 rounded-lg shadow-xl border-b-4 border-green-800 text-center w-3/4">
                        <div class="text-lg mb-1">حفظ الطلب بقيم منفصلة</div>
                        <div class="text-xs bg-green-700 py-1 px-2 rounded inline-block">
                            Profit = Delivery Fee - Driver Payout
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <!-- Technical Recommendations -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
            <div class="bg-gray-800 text-white p-6 rounded-xl">
                <h3 class="text-xl font-bold mb-4 text-orange-400">توصيات قاعدة البيانات</h3>
                <ul class="space-y-3 text-sm text-gray-300">
                    <li class="flex items-start">
                        <span class="mr-2 text-green-400">✓</span>
                        فصل جدول <code>restaurant_fees</code> (يربط ID بالمسافة).
                    </li>
                    <li class="flex items-start">
                        <span class="mr-2 text-green-400">✓</span>
                        فصل جدول <code>driver_payout_tiers</code> (مسافة فقط).
                    </li>
                    <li class="flex items-start">
                        <span class="mr-2 text-green-400">✓</span>
                        تخزين القيم النهائية كثوابت في جدول الطلبات لمنع التغيير المستقبلي.
                    </li>
                </ul>
            </div>
            <div class="bg-gray-800 text-white p-6 rounded-xl">
                <h3 class="text-xl font-bold mb-4 text-blue-400">توصيات واجهة المستخدم (UI)</h3>
                <ul class="space-y-3 text-sm text-gray-300">
                    <li class="flex items-start">
                        <span class="mr-2 text-green-400">✓</span>
                        تطبيق السائق (Ionic): يظهر فقط <code>driver_payout</code>.
                    </li>
                    <li class="flex items-start">
                        <span class="mr-2 text-green-400">✓</span>
                        لوحة التحكم (Admin): تظهر <code>delivery_fee</code> والهامش.
                    </li>
                    <li class="flex items-start">
                        <span class="mr-2 text-green-400">✓</span>
                        التاجر: يرى الرسوم المتفق عليها فقط.
                    </li>
                </ul>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 text-gray-400 py-8 mt-12 text-center">
        <p class="text-sm">تقرير الآليات التقنية والمالية - نسخة داخلية</p>
    </footer>

    <!-- JavaScript for Charts -->
    <script>
        // --- Utility: Label Wrapping (16 chars) ---
        function wrapLabel(label) {
            if (typeof label !== 'string' || label.length <= 16) return label;
            const words = label.split(' ');
            const lines = [];
            let currentLine = words[0];

            for (let i = 1; i < words.length; i++) {
                if ((currentLine + " " + words[i]).length <= 16) {
                    currentLine += " " + words[i];
                } else {
                    lines.push(currentLine);
                    currentLine = words[i];
                }
            }
            lines.push(currentLine);
            return lines;
        }

        // --- Common Chart Options ---
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    titleFont: { family: 'Cairo', size: 14 },
                    bodyFont: { family: 'Cairo', size: 13 },
                    callbacks: {
                        title: function(tooltipItems) {
                            const item = tooltipItems[0];
                            let label = item.chart.data.labels[item.dataIndex];
                            if (Array.isArray(label)) {
                                return label.join(' ');
                            } else {
                                return label;
                            }
                        }
                    }
                },
                legend: {
                    labels: {
                        font: { family: 'Cairo', size: 12 }
                    }
                }
            }
        };

        // --- 1. Margin Chart (Donut) ---
        const ctxMargin = document.getElementById('marginChart').getContext('2d');
        new Chart(ctxMargin, {
            type: 'doughnut',
            data: {
                labels: [wrapLabel('أجر السائق (مصروف)'), wrapLabel('هامش الربح (صافي)')],
                datasets: [{
                    data: [70, 30], // Example data
                    backgroundColor: ['#2563EB', '#F97316'],
                    borderWidth: 0
                }]
            },
            options: {
                ...commonOptions,
                plugins: {
                    ...commonOptions.plugins,
                    legend: { position: 'bottom' }
                }
            }
        });

        // --- 2. Merchant Fees Chart (Bar) ---
        const ctxMerchant = document.getElementById('merchantChart').getContext('2d');
        new Chart(ctxMerchant, {
            type: 'bar',
            data: {
                labels: [
                    wrapLabel('مطعم أ (اتفاقية ذهبية)'), 
                    wrapLabel('مطعم ب (اتفاقية فضية)'), 
                    wrapLabel('مطعم ج (سعر عام)')
                ],
                datasets: [{
                    label: 'رسوم التوصيل المحصلة (5 كم)',
                    data: [120, 110, 100],
                    backgroundColor: [
                        'rgba(249, 115, 22, 0.9)', // Orange
                        'rgba(249, 115, 22, 0.7)', 
                        'rgba(249, 115, 22, 0.5)'
                    ],
                    borderColor: '#EA580C',
                    borderWidth: 1
                }]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'القيمة (ريال/عملة)', font: { family: 'Cairo' } }
                    },
                    x: {
                        ticks: { font: { family: 'Cairo' } }
                    }
                }
            }
        });

        // --- 3. Driver Chart (Line/Area) ---
        const ctxDriver = document.getElementById('driverChart').getContext('2d');
        new Chart(ctxDriver, {
            type: 'line',
            data: {
                labels: ['0-2 كم', '2-5 كم', '5-8 كم', '8-12 كم', '12+ كم'],
                datasets: [
                    {
                        label: 'أجر السائق الموحد (ثابت)',
                        data: [10, 15, 20, 28, 35], // Example payout tier data
                        borderColor: '#2563EB',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.1,
                        borderWidth: 3,
                        pointBackgroundColor: '#1E40AF',
                        pointRadius: 5
                    }
                ]
            },
            options: {
                ...commonOptions,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'الأجر المستحق للسائق', font: { family: 'Cairo' } }
                    }
                }
            }
        });
    </script>
</body>
</html>
